name: Pylint

on:
  push:
    branches: [ main, master ]
    paths:
      - 'donkeycar/**/*.py'
      - '.github/workflows/pylint.yml'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'donkeycar/**/*.py'
      - '.github/workflows/pylint.yml'

jobs:
  lint:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11"]
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libffi-dev libssl-dev libbz2-dev \
          libreadline-dev libsqlite3-dev libncurses-dev liblzma-dev \
          tk-dev xz-utils zlib1g-dev build-essential
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pylint
        # Install minimal dependencies for import checking
        pip install numpy pillow docopt tornado requests
        
    - name: Analysing the code with pylint
      working-directory: ./donkeycar
      continue-on-error: true
      run: |
        # Find all Python files in donkeycar (excluding tests and cache)
        python_files=$(find . -name "*.py" -not -path "*/tests/*" -not -path "*/__pycache__/*" -not -path "*/.git/*" -not -path "*/venv/*" -not -path "*/env/*")
        
        if [ -z "$python_files" ]; then
          echo "⚠️ No Python files found"
          exit 0
        fi
        
        # Run pylint with project-specific settings
        echo "$python_files" | xargs pylint \
          --max-line-length=120 \
          --disable=missing-docstring,too-few-public-methods,too-many-arguments,too-many-instance-attributes,too-many-locals \
          --ignore-patterns="tests,__pycache__,venv,env,.git" \
          --fail-under=5
          
    - name: Pylint summary
      if: always()
      run: |
        echo "✅ Code analysis completed"
        echo "Python version: ${{ matrix.python-version }}"

